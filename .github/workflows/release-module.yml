name: Build & Release KernelSU Module

permissions:
  contents: write

on:
  push:
    paths:
      - 'module/module.prop'    # Trigger only when module.prop changes

jobs:
  build-release:
    runs-on: ubuntu-latest
    steps:
      # 1. Checkout the repository
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2. Set module info
      - name: Set module info
        id: module_info
        run: |
          VERSION=$(grep '^version=' module/module.prop | cut -d= -f2)
          SHORT_SHA=$(git rev-parse --short HEAD)
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "SHORT_SHA=$SHORT_SHA" >> $GITHUB_ENV
          echo "RELEASE_NAME=v${VERSION}-${SHORT_SHA}" >> $GITHUB_ENV
          echo "ZIP_NAME=Motorola-OTA-Blocker-KernelSU-${VERSION}-${SHORT_SHA}.zip" >> $GITHUB_ENV
          # Read CHANGELOG.md for the release description
          if [ -f CHANGELOG.md ]; then
            RELEASE_BODY=$(cat CHANGELOG.md)
          else
            RELEASE_BODY="Release of KernelSU module version ${VERSION} (commit ${SHORT_SHA})."
          fi
          echo "RELEASE_BODY<<EOF" >> $GITHUB_ENV
          echo "$RELEASE_BODY" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      # 3. Build the module zip
      - name: Build module zip
        run: |
          cd module
          zip -r ../$ZIP_NAME *
          cd ..

      # 4. Create GitHub Release
      - name: Create GitHub release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.RELEASE_NAME }}
          name: ${{ env.RELEASE_NAME }}
          body: ${{ env.RELEASE_BODY }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 5. Upload ZIP to release
      - name: Upload release asset
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ env.ZIP_NAME }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

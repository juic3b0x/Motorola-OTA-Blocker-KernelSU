name: Build & Release KernelSU Module

# Permissions required for creating release & uploading assets
permissions:
  contents: write

# Trigger only when module.prop changes
on:
  push:
    paths:
      - 'module/module.prop'

jobs:
  build-release:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2️⃣ Set module info
      - name: Set module info
        id: module_info
        run: |
          VERSION=$(grep '^version=' module/module.prop | cut -d= -f2)
          SHORT_SHA=$(git rev-parse --short HEAD)
          RELEASE_NAME="v${VERSION}-${SHORT_SHA}"
          ZIP_NAME="Motorola-OTA-Blocker-KernelSU-${VERSION}-${SHORT_SHA}.zip"
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "SHORT_SHA=$SHORT_SHA" >> $GITHUB_ENV
          echo "RELEASE_NAME=$RELEASE_NAME" >> $GITHUB_ENV
          echo "ZIP_NAME=$ZIP_NAME" >> $GITHUB_ENV

          # Read CHANGELOG.md for release description, only include the current version
          if [ -f CHANGELOG.md ]; then
            # Extract lines from ## v<version> until next ## or end of file
            RELEASE_BODY=$(awk "/## v$VERSION/{flag=1; next} /^## /{flag=0} flag" CHANGELOG.md)
            # Include version header
            RELEASE_BODY="## v$VERSION\n$RELEASE_BODY"
          else
            RELEASE_BODY="Release of KernelSU module version $VERSION (commit $SHORT_SHA)."
          fi
          echo "RELEASE_BODY<<EOF" >> $GITHUB_ENV
          echo "$RELEASE_BODY" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      # 3️⃣ Build the module zip
      - name: Build module zip
        run: |
          cd module
          zip -r ../$ZIP_NAME *
          cd ..

      # 4️⃣ Create Git tag if it doesn't exist
      - name: Create tag if missing
        run: |
          if git rev-parse -q --verify "refs/tags/${RELEASE_NAME}" >/dev/null; then
            echo "Tag ${RELEASE_NAME} already exists"
          else
            git config user.name "GitHub Actions"
            git config user.email "actions@github.com"
            git tag "${RELEASE_NAME}"
            git push origin "${RELEASE_NAME}"
          fi

      # 5️⃣ Create or update GitHub release
      - name: Create GitHub release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.RELEASE_NAME }}
          name: ${{ env.RELEASE_NAME }}
          body: ${{ env.RELEASE_BODY }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 6️⃣ Upload module zip to release
      - name: Upload release asset
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ env.ZIP_NAME }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
